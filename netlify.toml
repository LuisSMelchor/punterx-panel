# ===============================
# Netlify config unificado PunterX
# ===============================

[build]
  # Si no tienes build, este comando no falla y deja /public
  command = "npm run build || echo 'no build step'; mkdir -p public"
  publish  = "public"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  TZ = "America/Toronto" # Ajusta si prefieres MX: America/Mexico_City

# Defaults para TODAS las funciones
[functions]
  node_bundler = "esbuild"

# -------------------------------
# Diagnóstico (URL pública + cron)
# -------------------------------
# --- HTTP (URL pública) ---
[functions."diagnostico-total"]
  included_files = [
    "netlify/functions/_supabase-client.cjs",
    "netlify/functions/_diag-core-v4.cjs"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "openai",
    "node-fetch"
  ]


# ---------------------------------------
# Envíos (sin cron; endpoint HTTP público)
# ---------------------------------------
[functions."send"]
  external_node_modules = ["node-fetch"]

# --------------------------------------
# Autopick pre-match (cron frecuente)
# --------------------------------------
[functions."autopick-vip-nuevo"]
  # CRON: cada 15 minutos (ajusta si usabas otro)
  schedule = "*/15 * * * *"
  included_files = [
    "netlify/functions/_supabase-client.cjs",
    "prompts_punterx.md"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "openai",
    "node-fetch"
  ]

# ---------------------------------------------------
# Autopick en background (cron frecuente, mismo ritmo)
# ---------------------------------------------------
[functions."autopick-vip-nuevo-background"]
  # CRON: cada 15 minutos (ajusta si usabas otro)
  schedule = "*/15 * * * *"
  included_files = [
    "netlify/functions/_supabase-client.cjs",
    "prompts_punterx.md"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "openai",
    "node-fetch"
  ]

# --------------------------------------
# Outrights (menos frecuente por volumen)
# --------------------------------------
[functions."autopick-outrights"]
  # CRON: cada 6 horas (ajusta si usabas otro)
  schedule = "0 */6 * * *"
  included_files = [
    "netlify/functions/_supabase-client.cjs",
    "prompts_punterx.md"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "openai",
    "node-fetch"
  ]

# --------------------------------------
# Análisis semanal (ej. lunes al mediodía)
# --------------------------------------
[functions."analisis-semanal"]
  # CRON: lunes 12:00 (ajusta si usabas otro)
  schedule = "0 12 * * MON"
  included_files = [
    "netlify/functions/_supabase-client.cjs"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "node-fetch"
  ]

# --------------------------------------
# Verificador de aciertos (regular)
# --------------------------------------
[functions."verificador-aciertos"]
  # CRON: cada 30 minutos (ajusta si usabas otro)
  schedule = "*/30 * * * *"
  included_files = [
    "netlify/functions/_supabase-client.cjs"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "node-fetch"
  ]

# --------------------------------------
# Memoria inteligente (mantenimiento regular)
# --------------------------------------
[functions."memoria-inteligente"]
  # CRON: a los 15 de cada hora (ajusta si usabas otro)
  schedule = "15 * * * *"
  included_files = [
    "netlify/functions/_supabase-client.cjs"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "node-fetch"
  ]

# --------------------------------------
# Check de estado (ligero y frecuente)
# --------------------------------------
[functions."check-status"]
  # CRON: cada 10 minutos (ajusta si usabas otro)
  schedule = "*/10 * * * *"
  included_files = [
    "netlify/functions/_supabase-client.cjs"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "node-fetch"
  ]

# ----------------
# Redirects útiles
# ----------------
[[redirects]]
  from = "/diag"
  to = "/.netlify/functions/diagnostico-total"
  status = 200
