# netlify.toml — PunterX (estable)

[build]
  command = "npm run build || echo 'no build step'; mkdir -p public"
  publish = "public"
  [build.environment]
    NODE_VERSION = "20" # Recomendado por Netlify/Supabase

[functions]
  node_bundler = "esbuild"

# Asegura que el shim y dependencias dinámicas estén disponibles en RUNTIME
[functions."diagnostico-total"]
  included_files = [
    "netlify/functions/_supabase-client.cjs"
  ]
  external_node_modules = [
    "@supabase/supabase-js",
    "openai",
    "node-fetch"
  ]

# (Opcional) send.js también usa fetch → no necesita included_files,
# pero lo declaramos por consistencia (no es obligatorio)
[functions."send"]
  external_node_modules = ["node-fetch"]

############################################
# FUNCIONES + SCHEDULES (sin duplicados)
############################################

# Principal
[functions."autopick-vip-nuevo"]
  schedule = "*/15 * * * *"

# Background: corre al minuto 2, 17, 32, 47 de cada hora
[functions."autopick-vip-nuevo-background"]
  schedule = "2-59/15 * * * *"

# Verificador: cada hora
[functions."verificador-aciertos"]
  schedule = "0 * * * *"

# Análisis semanal: lunes 06:00
[functions."analisis-semanal"]
  schedule = "0 6 * * 1"

# Diagnóstico/refresh dashboard: cada 10 min
# Forzamos esbuild aquí también para que respete included_files y external_node_modules.
[functions."diagnostico-total"]
  node_bundler = "esbuild"
  external_node_modules = ["@supabase/supabase-js"]
  included_files = ["netlify/functions/_supabase-client.cjs"]
  schedule = "*/10 * * * *"

# Outrights: cada 30 min
[functions."autopick-outrights"]
  schedule = "*/30 * * * *"
