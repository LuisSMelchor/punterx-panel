üìÑ PunterX ‚Äî Configuraci√≥n y Estado Actual (Actualizado)

Fecha: 17 de agosto de 2025
Estado: ‚úÖ Deploy completado, logs instrumentados. ‚è≥ En espera de pr√≥ximos ciclos para validar reducci√≥n total de ‚ÄúSin coincidencias en API-FOOTBALL‚Äù y calidad de picks.

0) Resumen ejecutivo

PunterX es un sistema automatizado que detecta y publica picks de alto EV usando OddsAPI (cuotas), API-FOOTBALL PRO (datos de partido), OpenAI GPT-5 (an√°lisis en JSON), Supabase (hist√≥rico/memoria) y Telegram (FREE/VIP).
El sistema ahora incluye:

Match Resolver propio (OddsAPI ‚Üî API-FOOTBALL) con normalizaci√≥n avanzada y scoring (Jaccard + boosts) para emparejar equipos/liga/fecha sin depender solo de search=.

Estrategia league_id+date como intento primario, con fallbacks robustos (search, teams, h2h ¬±2d).

Logs de trazabilidad en puntos cr√≠ticos (ventana, resolver, enriquecimiento, OpenAI, guardado) para auditor√≠a r√°pida.

Bandera y pa√≠s en PRE y VIP, Top-3 ordenado (mejor en negritas), anti-duplicado LIVE por minute_bucket.

Presupuesto de IA por ciclo y retry ajustado cuando hay finish_reason: length.

1) Arquitectura (alto nivel)

Runtime: Netlify Functions (Node 20, CommonJS, esbuild)

Fuentes:

OddsAPI ‚Üí cuotas pre/live (mercados h2h/totals/spreads)

API-FOOTBALL PRO ‚Üí fixtures, minuto/estado, marcador, √°rbitro, clima

IA: OpenAI GPT-5 (primario) con GPT-5-mini (fallback) ‚Üí JSON estructurado

Persistencia: Supabase (picks_historicos + tablas de diagn√≥stico opcionales)

Distribuci√≥n: Telegram Bot API (FREE channel, VIP group)

Operaci√≥n: Netlify Cron; loop local opcional para LIVE

Coherencia: CommonJS sin top-level await; formatos y reglas de EV consistentes

2) Archivos clave y m√≥dulos nuevos

netlify/functions/autopick-vip-nuevo.cjs ‚Äî PRE-match (ventana principal 40‚Äì55; fallback 35‚Äì70)

‚úÖ NUEVO: Logs finos (ventanas, contadores, modelo IA, EV, guardado, errores Telegram).

‚úÖ NUEVO: Match Resolver previo al enriquecimiento con AF.

‚úÖ NUEVO: Enriquecimiento por league_id+date y fallbacks (search, teams + fixtures?h2h).

‚úÖ NUEVO: Pa√≠s + bandera en mensajes; Top-3 con #1 en negritas.

‚úÖ NUEVO: Presupuesto de IA por ciclo y retry con max_completion_tokens adaptativo.

netlify/functions/autopick-live.cjs ‚Äî EN VIVO (in-play)
OddsAPI-first (prefiltro valor), AF para minuto/fase/score, IA/EV/validaciones, FREE/VIP (VIP pin+edit), anti-duplicado por minute_bucket.

netlify/functions/autopick-outrights.cjs ‚Äî A futuro (teaser 6‚Äì8d; final 22‚Äì26h)
League map y resoluci√≥n por /leagues?id= con fallback a search.

netlify/functions/send.js ‚Äî helpers de env√≠o a Telegram (PRE/LIVE/OUTRIGHT)

M√≥dulos nuevos en _lib/

_lib/match-helper.js ‚Äî Normalizaci√≥n de cadenas, Jaccard score con boosts, resolveTeamsAndLeague (umbral configurable con MATCH_RESOLVE_CONFIDENCE).

_lib/af-resolver.cjs ‚Äî resolveFixtureFromList: elige fixture mejor puntuado desde una lista AF (usa nameScore, Boost temporal ¬±36‚Äì60h).

prompts_punterx.md ‚Äî prompts IA consolidados (secci√≥n 1) con placeholders ({{CONTEXT_JSON}}, {{OPCIONES_APOSTABLES_LIST}})

PunterX-Config.md ‚Äî este documento

3) Flujo actualizado de PRE-match

OddsAPI recupera eventos ‚áí se filtran ya iniciados ‚áí se valida ventana

Principal: 40‚Äì55 min, Fallback: 35‚Äì70 min

Logs: DBG commence_time=... mins=... y totales por bucket

Match Resolver (nuevo)

match-helper.resolveTeamsAndLeague({ home, away, sport_title })

Normalizaci√≥n (acentos, stopwords ‚Äúfc/cf/sc/afc/club/deportivo/the/el/la/los/las/de/do/da/unam‚Äù‚Ä¶), Jaccard + boosts por igualdad e inclusi√≥n (p.ej. ‚Äúpumas‚Äù ‚Üî ‚Äúpumas unam‚Äù)

Aplica umbral MATCH_RESOLVE_CONFIDENCE (default sugerido: 0.75)

Log: RESOLVE > home="Toluca"‚Üí"Deportivo Toluca" | away="Pumas"‚Üí"Pumas UNAM" | liga="N/D"‚Üí"Liga MX"

Enriquecimiento con API-FOOTBALL (mejorado)

Intento 1: fixtures?date=YYYY-MM-DD&league={id} (v√≠a AF_LEAGUE_ID_BY_TITLE)

Intento 2: fixtures?league={id}&from=YYYY-MM-DD&to=YYYY-MM-DD (¬±2d)

Intento 3: fixtures?search=HOME AWAY (y luego por cada equipo)

Intento 4: teams?search= ‚Üí IDs ‚Üí fixtures?h2h=homeId-awayId&from=...&to=... (¬±2d)

Selecci√≥n por score: nombres (home/away directo o swapped) + boost temporal (¬±36‚Äì60h)

Logs: ‚ÄúResolver AF: asignado fixture_id=‚Ä¶‚Äù, ‚ÄúPuntaje bajo (‚Ä¶) para mejor candidato‚Äù y ‚ÄúSin coincidencias ‚Ä¶‚Äù con debug normalizado

Construcci√≥n de prompt con opciones apostables reales (Top mercados y mejor cuota por mercado)

OpenAI GPT-5 ‚Üí JSON

Solo JSON; si length, retry con max_completion_tokens ‚Üë

Presupuesto por ciclo: MAX_OAI_CALLS_PER_CYCLE

Validaciones: probabilidad ‚àà [5%, 85%], coherencia con impl√≠cita ‚â§15 p.p.

EV y guardado

EV ‚â•10% requerido

FREE: 10‚Äì14.9%, VIP: ‚â•15%

Guardar en Supabase (PRE/LIVE/OUTRIGHT), Top-3 en top3_json, pa√≠s y liga, sin duplicar (clave evento)

Env√≠o a Telegram

FREE y/o VIP (VIP con bandera, pa√≠s y Top-3 #1 en negritas)

4) Formatos de mensaje (consolidado)
4.1 PRE ‚Äî FREE
üì° RADAR DE VALOR
üèÜ {bandera} {pais} - {liga}
‚öîÔ∏è {home} vs {away}
‚è±Ô∏è {inicio_relativo}

{analisis_gratuito}

‚è≥ Quedan menos de {mins} minutos para este encuentro.

üîé IA Avanzada, monitoreando el mercado global 24/7.
‚ö†Ô∏è Este contenido es informativo. Apostar conlleva riesgo.

4.2 PRE ‚Äî VIP
üéØ PICK NIVEL: {emoji} {nivel}
üèÜ {bandera} {pais} - {liga}
‚öîÔ∏è {home} vs {away}
‚è±Ô∏è {inicio_relativo}

üß† {analisis_vip}

EV: {ev}% | Posibilidades de acierto: {prob}% | Momio: {momio_americano}
üí° Apuesta sugerida: {apuesta}
üí∞ Cuota usada: {cuota} {[@ point opcional]}

üìã Apuestas extra:
{apuestas_extra}

üèÜ Mejores 3 casas:
<b>{bookie1 ‚Äî cuota1}</b>
{bookie2 ‚Äî cuota2}
{bookie3 ‚Äî cuota3}

{datos_opcionales}

üîé {TAGLINE}
‚ö†Ô∏è Este contenido es informativo. Apostar conlleva riesgo.

4.3 LIVE ‚Äî FREE y 4.4 LIVE ‚Äî VIP

(Se conservan como en la versi√≥n previa; incluyen minuto, marcador, fase, vigencia, snapshot, pin/edit en VIP).

5) Validaciones y niveles

Reglas IA:

apuesta ‚àà opciones apostables vigentes

probabilidad ‚àà [5, 85]

|prob(model) ‚àí prob(impl√≠cita)| ‚â§ 15 p.p.

Corte de EV: ‚â•10% (FREE 10‚Äì14.9, VIP ‚â•15)

Niveles VIP: üü£ Ultra (‚â•40), üéØ √âlite (30‚Äì39.9), ü•à Avanzado (20‚Äì29.9), ü•â Competitivo (15‚Äì19.9)

6) Anti-duplicado LIVE

Clave: (fixture_id, minute_bucket) (bucket de 5 min) durante 90 min

Nuevo campo minute_bucket en picks_historicos

Env√≠o/edit controlado con cooldown LIVE_COOLDOWN_MIN

7) Variables de entorno (nuevas y existentes)

A√±adir/ajustar en Netlify ‚Üí Site settings ‚Üí Environment variables:

# === Ventanas PRE ===
WINDOW_MAIN_MIN=40
WINDOW_MAIN_MAX=55
WINDOW_FB_MIN=35
WINDOW_FB_MAX=70

# === IA / OpenAI ===
OPENAI_API_KEY=...
OPENAI_MODEL=gpt-5
OPENAI_MODEL_FALLBACK=gpt-5-mini
MAX_OAI_CALLS_PER_CYCLE=40
SOFT_BUDGET_MS=70000

# === Resolver / Matching ===
MATCH_RESOLVE_CONFIDENCE=0.75       # Umbral global del Match Helper (0‚Äì1)
COUNTRY_FLAG=üá≤üáΩ                    # Bandera por defecto si no se resuelve pa√≠s

# === OddsAPI ===
ODDS_API_KEY=...
# Pre:
PREFILTER_MIN_BOOKIES=2
# Live:
LIVE_MIN_BOOKIES=3
LIVE_POLL_MS=25000
LIVE_COOLDOWN_MIN=8
LIVE_MARKETS=h2h,totals,spreads
LIVE_REGIONS=eu,uk,us
LIVE_PREFILTER_GAP_PP=5
RUN_WINDOW_MS=60000

# === API-FOOTBALL ===
API_FOOTBALL_KEY=...

# === Supabase ===
SUPABASE_URL=...
SUPABASE_KEY=...

# === Telegram ===
TELEGRAM_BOT_TOKEN=...
TELEGRAM_CHANNEL_ID=...   # FREE
TELEGRAM_GROUP_ID=...     # VIP

8) netlify.toml (extracto)
[functions]
  node_bundler = "esbuild"

[functions."autopick-vip-nuevo"]
  included_files = ["prompts_punterx.md", "netlify/functions/send.js", "netlify/_lib/*"]
  external_node_modules = ["@supabase/supabase-js", "openai"]

[functions."autopick-live"]
  timeout = 60
  included_files = ["prompts_punterx.md", "netlify/functions/send.js", "netlify/_lib/*"]
  external_node_modules = ["@supabase/supabase-js", "openai"]


(Ajusta crons/headers/redirects seg√∫n tu setup.)

9) Supabase ‚Äî SQL idempotente
-- Tabla base
CREATE TABLE IF NOT EXISTS public.picks_historicos (
  id               bigserial PRIMARY KEY,
  evento           text,
  analisis         text,
  apuesta          text,
  tipo_pick        text,               -- 'PRE' | 'LIVE' | 'OUTRIGHT'
  liga             text,
  equipos          text,
  ev               numeric,
  probabilidad     numeric,
  nivel            text,
  timestamp        timestamptz DEFAULT now(),
  is_live          boolean DEFAULT false,
  kickoff_at       timestamptz,
  minute_at_pick   int,
  phase            text,
  score_at_pick    text,
  market_point     text,
  vigencia_text    text,
  top3_json        jsonb,
  consenso_json    jsonb,
  pais             text
);

-- Campos nuevos/compatibilidad
ALTER TABLE public.picks_historicos
  ADD COLUMN IF NOT EXISTS minute_bucket int;

-- Normalizaciones
UPDATE public.picks_historicos
SET is_live = COALESCE(is_live, false)
WHERE is_live IS DISTINCT FROM false;

-- √çndices
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='idx_picks_tipo') THEN
    CREATE INDEX idx_picks_tipo ON public.picks_historicos (tipo_pick);
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='idx_picks_evento') THEN
    CREATE INDEX idx_picks_evento ON public.picks_historicos (evento);
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='idx_picks_timestamp') THEN
    CREATE INDEX idx_picks_timestamp ON public.picks_historicos (timestamp DESC);
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='idx_picks_is_live') THEN
    CREATE INDEX idx_picks_is_live ON public.picks_historicos (is_live);
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='idx_picks_minute_bucket') THEN
    CREATE INDEX idx_picks_minute_bucket ON public.picks_historicos (minute_bucket);
  END IF;
END $$;

10) package.json (scripts √∫tiles)
{
  "scripts": {
    "pre": "node netlify/functions/autopick-vip-nuevo.cjs",
    "out": "node netlify/functions/autopick-outrights.cjs",
    "live": "node netlify/functions/autopick-live.cjs --loop"
  }
}


Nota: En monorepo, asegura working-directory correcto en CI y un √∫nico objeto JSON ra√≠z v√°lido.

11) Observabilidad y puntos de log a√±adidos

Ventanas / filtrado:
Filtrados X eventos ya comenzados (omitidos)
DBG commence_time=‚Ä¶ mins=‚Ä¶
üìä Filtrado (OddsAPI): Principal=‚Ä¶ | Fallback=‚Ä¶ | Total recibidos=‚Ä¶

Match Resolver / AF:
RESOLVE > home="‚Ä¶"‚Üí"‚Ä¶" | away="‚Ä¶"‚Üí"‚Ä¶" | liga="‚Ä¶"‚Üí"‚Ä¶"
Resolver AF: asignado fixture_id=‚Ä¶ league="‚Ä¶"
Puntaje bajo (‚Ä¶) para mejor candidato ( ‚Ä¶ )
Sin coincidencias en API-Football (search="‚Ä¶", homeN="‚Ä¶", awayN="‚Ä¶")

OpenAI:
[OAI] meta= {"model":"‚Ä¶","ms":‚Ä¶,"finish_reason":"‚Ä¶","usage":{‚Ä¶}}
‚ôªÔ∏è Fallback de modelo ‚Üí gpt-5-mini
üîé Modelo usado: ‚Ä¶
üõë no_pick=true ‚Üí ‚Ä¶

EV / guardado / env√≠os:
EV XX% < 10% ‚Üí descartado
‚úÖ Enviado VIP | ‚ö†Ô∏è Fall√≥ env√≠o VIP
‚úÖ Enviado FREE | ‚ö†Ô∏è Fall√≥ env√≠o FREE
Pick duplicado, no guardado
üèÅ Resumen ciclo: {...} y Duration: ‚Ä¶ ms | Memory Usage: ‚Ä¶ MB

12) Checklist de QA

 Ventanas PRE cumplen 40‚Äì55 (principal) / 35‚Äì70 (fallback)

 Resolver de equipos/liga activo y con MATCH_RESOLVE_CONFIDENCE aplicado

 Enriquecimiento AF via league_id+date y fallbacks funcionando

 Mensajes PRE/VIP con bandera/pa√≠s y Top-3 correcto (#1 en negritas)

 Presupuesto IA respeta MAX_OAI_CALLS_PER_CYCLE; retry ante length

 Supabase guarda PRE/LIVE/OUTRIGHT con top3_json, pais y minute_bucket (LIVE)

 Anti-duplicado LIVE por bucket 5‚Äô sin bloquear el fixture completo

 Telegram FREE/VIP OK; VIP con pin/edit en LIVE

13) Cambios recientes (agosto 2025)

Match Resolver (OddsAPI ‚Üî AF) con normalizaci√≥n, Jaccard y boosts; umbral MATCH_RESOLVE_CONFIDENCE.

AF por league_id+date como camino primario; fallbacks: search, teams+fixtures?h2h.

Logs de trazabilidad en PRE (ventanas, resolver, AF, IA, EV, guardado).

OpenAI: retry solo si length, max_completion_tokens adaptativo, l√≠mite por ciclo.

Bandera/pa√≠s en mensajes; Top-3 reorganizado (#1 en negritas); frases de responsabilidad.

Supabase: minute_bucket para anti-duplicado LIVE + √≠ndices extra.

Outrights: mapas de liga por sportkey y resoluci√≥n precisa por /leagues?id=.

14) Notas finales y pr√≥ximos pasos

Estamos a la espera de los pr√≥ximos logs para confirmar la ca√≠da sustancial de ‚ÄúSin coincidencias en API-FOOTBALL‚Äù y la estabilidad del flujo completo.

Si persiste alg√∫n ‚Äúno match‚Äù, ampliar stopwords del normalizador y/o el mapa AF_LEAGUE_ID_BY_TITLE.

Mantener cortes de EV y restricciones de probabilidad/impl√≠cita.

Evitar spam LIVE: m√°x. 3 ediciones por partido, con LIVE_COOLDOWN_MIN activo.

Documentar cualquier ajuste en prompts o variables aqu√≠ mismo.

TAGLINE

üîé IA Avanzada, monitoreando el mercado global 24/7 en busca de oportunidades ocultas y valiosas.
